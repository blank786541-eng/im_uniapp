import{d as e,c as t,o as s,a as o,u as a,E as n,t as i,b as l,F as r,r as v,n as c,i as u,e as d,f as M,g as T,h as p,j as I,k as g,l as S,s as _,m as y,w as m,p as N,q as E}from"./index-CA_4_S1o.js";import{o as V,a as x}from"./uni-app.es.f5Xd5cz1.js";import{E as C}from"./Empty.DhhBt1kg.js";import{A as k}from"./Avatar.cDMQ39ID.js";import{_ as A}from"./Appellation.vue_vue_type_script_setup_true_lang.Bn2FxhVA.js";import{I as U}from"./Icon.DO2Wg01x.js";import{d as h}from"./dayjs.min.CwOgZug2.js";import{E as f,e as O}from"./emoji.SrFHKbUG.js";import{_ as P}from"./_plugin-vue_export-helper.BCo6x5W8.js";import{t as K}from"./reporter.BDLo06V-.js";import{H as $}from"./HeaderInput.NhHrJsao.js";import"./AssetsImage.D01ldk7e.js";const Y=P(e({__name:"conversation-item-last-msg-content",props:{lastMessage:{}},setup(e){const T=e,p=t(()=>(e=>{if(!e)return[];const t=[];let s;const o=O;for(;null!==(s=o.exec(e));){t.push({type:"emoji",value:s[0],index:s.index});const o=" ".repeat(s[0].length);e=e.replace(s[0],o)}return(e=e.replace(o," "))&&e.split(" ").filter(e=>e.trim()).map(s=>{const o=null==e?void 0:e.indexOf(s);t.push({type:"text",value:s,index:o});const a=" ".repeat(s.length);e=e.replace(s,a)}),t.sort((e,t)=>e.index-t.index).map((e,t)=>({...e,key:t+e.type}))})(T.lastMessage.text)),I=e=>`[${{textMsgText:l("textMsgText"),customMsgText:l("customMsgText"),audioMsgText:l("audioMsgText"),videoMsgText:l("videoMsgText"),fileMsgText:l("fileMsgText"),callMsgText:l("callMsgText"),geoMsgText:l("geoMsgText"),imgMsgText:l("imgMsgText"),notiMsgText:l("notiMsgText"),robotMsgText:l("robotMsgText"),tipMsgText:l("tipMsgText"),unknowMsgText:l("unknowMsgText")}[e]||""}]`;return(e,t)=>(s(),o("div",null,[T.lastMessage.lastMessageState===a(n).V2NIMLastMessageState.V2NIM_MESSAGE_STATUS_REVOKE?(s(),o("div",{key:0},i(a(l)("recall")),1)):T.lastMessage.messageType===a(n).V2NIMMessageType.V2NIM_MESSAGE_TYPE_NOTIFICATION?(s(),o("div",{key:1},i(a(l)("conversationNotificationText")),1)):T.lastMessage.sendingState===a(n).V2NIMMessageSendingState.V2NIM_MESSAGE_SENDING_STATE_FAILED?(s(),o("div",{key:2},i(a(l)("conversationSendFailText")),1)):T.lastMessage.messageType===a(n).V2NIMMessageType.V2NIM_MESSAGE_TYPE_FILE?(s(),o("div",{key:3},i(I("fileMsgText")),1)):T.lastMessage.messageType===a(n).V2NIMMessageType.V2NIM_MESSAGE_TYPE_IMAGE?(s(),o("div",{key:4},i(I("imgMsgText")),1)):T.lastMessage.messageType===a(n).V2NIMMessageType.V2NIM_MESSAGE_TYPE_CUSTOM?(s(),o("div",{key:5},i(T.lastMessage.text||I("customMsgText")),1)):T.lastMessage.messageType===a(n).V2NIMMessageType.V2NIM_MESSAGE_TYPE_AUDIO?(s(),o("div",{key:6},i(I("audioMsgText")),1)):T.lastMessage.messageType===a(n).V2NIMMessageType.V2NIM_MESSAGE_TYPE_CALL?(s(),o("div",{key:7},i(I("callMsgText")),1)):T.lastMessage.messageType===a(n).V2NIMMessageType.V2NIM_MESSAGE_TYPE_LOCATION?(s(),o("div",{key:8},i(I("geoMsgText")),1)):T.lastMessage.messageType===a(n).V2NIMMessageType.V2NIM_MESSAGE_TYPE_ROBOT?(s(),o("div",{key:9},i(I("robotMsgText")),1)):T.lastMessage.messageType===a(n).V2NIMMessageType.V2NIM_MESSAGE_TYPE_TIPS?(s(),o("div",{key:10},i(I("tipMsgText")),1)):T.lastMessage.messageType===a(n).V2NIMMessageType.V2NIM_MESSAGE_TYPE_VIDEO?(s(),o("div",{key:11},i(I("videoMsgText")),1)):T.lastMessage.messageType===a(n).V2NIMMessageType.V2NIM_MESSAGE_TYPE_TEXT?(s(),o("div",{key:12,class:"msg-conversation-text-wrap"},[(s(!0),o(r,null,v(p.value,e=>(s(),o(r,{key:e.key},["text"===e.type?(s(),o("span",{key:0,class:"msg-conversation-text"},i(e.value),1)):"emoji"===e.type?(s(),o("span",{key:1,class:c(a(u)?"msg-conversation-text-emoji-wx":"msg-conversation-text-emoji")},[d(U,{type:a(f)[e.value],size:16},null,8,["type"])],2)):M("",!0)],64))),128))])):M("",!0)]))}}),[["__scopeId","data-v-6cf52884"]]),w=P(e({__name:"conversation-item",props:{conversation:{},showMoreActions:{type:Boolean,default:!1}},emits:["click","delete","stickyToTop","leftSlide"],setup(e,{emit:u}){const _=e,y=u,m=t(()=>[{name:_.conversation.stickTop?l("deleteStickTopText"):l("addStickTopText"),class:"action-top",type:"action-top"},{name:l("deleteSessionText"),class:"action-delete",type:"action-delete"}]),N=t(()=>uni.$UIKitNIM.V2NIMConversationIdUtil.parseConversationTargetId(_.conversation.conversationId)),E=uni.$UIKitStore.localOptions.loginStateVisible,V=T(!1),x=t(()=>{if(_.conversation.type===n.V2NIMConversationType.V2NIM_CONVERSATION_TYPE_TEAM){const{avatar:e}=_.conversation;return e}}),C=t(()=>_.conversation.name?_.conversation.name:_.conversation.conversationId),f=T(!1),O=t(()=>{var e;const t=(null==(e=_.conversation.lastMessage)?void 0:e.messageRefer.createTime)||_.conversation.updateTime;if(!t)return"";const s=h(t),o=s.isSame(h(),"day"),a=s.isSame(h(),"year");return s.format(o?"HH:mm":a?"MM-DD HH:mm":"YYYY-MM-DD HH:mm")}),P=t(()=>_.conversation.unreadCount>0?_.conversation.unreadCount>99?"99+":_.conversation.unreadCount+"":""),K=t(()=>!!_.conversation.mute),$=t(()=>{var e;return!!(null==(e=_.conversation.aitMsgs)?void 0:e.length)});t(()=>{var e,t,s,o,a,i,l,r,v,c;const u=uni.$UIKitNIM.V2NIMLoginService.getLoginUser();return _.conversation.type===n.V2NIMConversationType.V2NIM_CONVERSATION_TYPE_P2P&&((null==(t=null==(e=null==_?void 0:_.conversation)?void 0:e.lastMessage)?void 0:t.messageRefer.senderId)===u&&(null==(o=null==(s=null==_?void 0:_.conversation)?void 0:s.lastMessage)?void 0:o.messageType)!==n.V2NIMMessageType.V2NIM_MESSAGE_TYPE_CALL&&(null==(i=null==(a=null==_?void 0:_.conversation)?void 0:a.lastMessage)?void 0:i.messageType)!==n.V2NIMMessageType.V2NIM_MESSAGE_TYPE_NOTIFICATION&&(null==(r=null==(l=null==_?void 0:_.conversation)?void 0:l.lastMessage)?void 0:r.sendingState)===n.V2NIMMessageSendingState.V2NIM_MESSAGE_SENDING_STATE_SUCCEEDED&&(null==(c=null==(v=null==_?void 0:_.conversation)?void 0:v.lastMessage)?void 0:c.lastMessageState)!==n.V2NIMLastMessageState.V2NIM_MESSAGE_STATUS_REVOKE)});let w=0,b=0;function G(e){w=e.changedTouches[0].pageX,b=e.changedTouches[0].pageY}function R(e){const t=e.changedTouches[0].pageX,s=e.changedTouches[0].pageY,o=t-w+20,a=s-b;Math.abs(o)>Math.abs(a)&&o>0?y("leftSlide",null):Math.abs(o)>Math.abs(a)&&o<0&&y("leftSlide",_.conversation)}function j(){_.showMoreActions?y("leftSlide",null):y("click",_.conversation)}const L=p(()=>{f.value=uni.$UIKitStore.aiUserStore.isAIUser(N.value)}),D=p(()=>{var e,t;if(_.conversation.type===n.V2NIMConversationType.V2NIM_CONVERSATION_TYPE_P2P){const s=null==(e=uni.$UIKitStore)?void 0:e.subscriptionStore.stateMap;s.get(N.value)&&uni.$UIKitStore.localOptions.loginStateVisible?V.value=(null==(t=s.get(N.value))?void 0:t.statusType)===n.V2NIMUserStatusType.V2NIM_USER_STATUS_TYPE_LOGIN:V.value=!1}});return I(()=>{L(),D()}),(e,t)=>(s(),o("div",{class:c(["conversation-item-container",{"show-action-list":e.showMoreActions,"stick-on-top":e.conversation.stickTop}]),onTouchstart:G,onTouchmove:R,onClick:j},[g("div",{class:"conversation-item-content"},[g("div",{class:"conversation-item-left"},[P.value?(s(),o("div",{key:0,class:"unread"},[K.value?(s(),o("div",{key:0,class:"dot"})):(s(),o("div",{key:1,class:"badge"},i(P.value),1))])):M("",!0),d(k,{account:N.value,avatar:x.value},null,8,["account","avatar"]),a(E)&&!f.value&&e.conversation.type===a(n).V2NIMConversationType.V2NIM_CONVERSATION_TYPE_P2P&&V.value?(s(),o("div",{key:1,class:"login-state-icon"})):M("",!0),!a(E)||f.value||e.conversation.type!==a(n).V2NIMConversationType.V2NIM_CONVERSATION_TYPE_P2P||V.value?M("",!0):(s(),o("div",{key:2,class:"unlogin-state-icon"}))]),g("div",{class:"conversation-item-right"},[g("div",{class:"conversation-item-top"},[e.conversation.type===a(n).V2NIMConversationType.V2NIM_CONVERSATION_TYPE_P2P?(s(),S(A,{key:0,class:"conversation-item-title",account:N.value},null,8,["account"])):(s(),o("span",{key:1,class:"conversation-item-title"},i(C.value),1)),g("span",{class:"conversation-item-time"},i(O.value),1)]),g("div",{class:"conversation-item-desc"},[$.value?(s(),o("span",{key:0,class:"beMentioned"},i("["+a(l)("someoneText")+"@"+a(l)("meText")+"]"),1)):M("",!0),_.conversation.lastMessage?(s(),o("span",{key:1,class:"conversation-item-desc-content"},[d(Y,{lastMessage:_.conversation.lastMessage},null,8,["lastMessage"])])):M("",!0),g("span",{class:"conversation-item-desc-ait"},[K.value?(s(),S(U,{key:0,iconClassName:"conversation-item-desc-state",type:"icon-xiaoximiandarao",color:"#ccc"})):M("",!0)])])])]),g("div",{class:"right-action-list"},[(s(!0),o(r,null,v(m.value,e=>(s(),o("div",{key:e.type,class:c(["right-action-item",e.class]),onClick:()=>{return t=e.type,void y("action-top"===t?"stickyToTop":"delete",_.conversation);var t}},i(e.name),11,["onClick"]))),128))])],34))}}),[["__scopeId","data-v-b3adbfe3"]]),b=P(e({__name:"index",setup(e){var t,i;const c=T([]),u=T(!1),g=T(""),E=null==(i=null==(t=uni.$UIKitStore)?void 0:t.sdkOptions)?void 0:i.enableV2CloudConversation,k=e=>{g.value=e?e.conversationId:""};let A=!1;const U=async e=>{var t,s;if(!A){g.value="";try{A=!0,e.type!==n.V2NIMConversationType.V2NIM_CONVERSATION_TYPE_TEAM&&e.type!==n.V2NIMConversationType.V2NIM_CONVERSATION_TYPE_SUPER_TEAM||(E?await(null==(t=uni.$UIKitStore.conversationStore)?void 0:t.markConversationReadActive(e.conversationId)):await(null==(s=uni.$UIKitStore.localConversationStore)?void 0:s.markConversationReadActive(e.conversationId))),await uni.$UIKitStore.uiStore.selectConversation(e.conversationId),N({url:"/pages/Chat/index"})}catch{uni.showToast({title:l("selectSessionFailText"),icon:"error"})}finally{A=!1}}},h=async e=>{var t,s;try{E?await(null==(t=uni.$UIKitStore.conversationStore)?void 0:t.deleteConversationActive(e.conversationId)):await(null==(s=uni.$UIKitStore.localConversationStore)?void 0:s.deleteConversationActive(e.conversationId)),g.value=""}catch{uni.showToast({title:l("deleteSessionFailText"),icon:"error"})}},f=async e=>{var t,s,o,a,n,i,r,v;if(e.stickTop)try{E?await(null==(s=null==(t=uni.$UIKitStore)?void 0:t.conversationStore)?void 0:s.stickTopConversationActive(e.conversationId,!1)):await(null==(a=null==(o=uni.$UIKitStore)?void 0:o.localConversationStore)?void 0:a.stickTopConversationActive(e.conversationId,!1))}catch{uni.showToast({title:l("deleteStickTopFailText"),icon:"error"})}else try{E?await(null==(i=null==(n=uni.$UIKitStore)?void 0:n.conversationStore)?void 0:i.stickTopConversationActive(e.conversationId,!0)):await(null==(v=null==(r=uni.$UIKitStore)?void 0:r.localConversationStore)?void 0:v.stickTopConversationActive(e.conversationId,!0))}catch{uni.showToast({title:l("addStickTopFailText"),icon:"error"})}},O=()=>{u.value=!1},P=e=>{if(uni.$UIKitStore.localOptions.loginStateVisible){const t=e.filter(e=>e.type===n.V2NIMConversationType.V2NIM_CONVERSATION_TYPE_P2P).map(e=>{var t;return null==(t=uni.$UIKitNIM)?void 0:t.V2NIMConversationIdUtil.parseConversationTargetId(e.conversationId)}),s=100,o=t.length;for(let e=0;e<o;e+=s){const o=t.slice(e,e+s);o.length>0&&uni.$UIKitStore.subscriptionStore.subscribeUserStatusActive(o)}}};K("ConversationUIKit");const Y=p(()=>{var e,t,s,o;const a=E?null==(t=null==(e=uni.$UIKitStore)?void 0:e.uiStore)?void 0:t.conversations:null==(o=null==(s=uni.$UIKitStore)?void 0:s.uiStore)?void 0:o.localConversations;c.value=null==a?void 0:a.map(e=>({...e,renderKey:e.conversationId})).sort((e,t)=>t.sortOrder-e.sortOrder),_()}),b=p(()=>{var e,t;(null==(e=uni.$UIKitStore)?void 0:e.connectStore.loginStatus)===n.V2NIMLoginStatus.V2NIM_LOGIN_STATUS_LOGINED&&(null==(t=uni.$UIKitStore)?void 0:t.connectStore.connectStatus)===n.V2NIMConnectStatus.V2NIM_CONNECT_STATUS_CONNECTED&&P(null==c?void 0:c.value)}),G=p(()=>{var e,t;null==(t=null==(e=uni.$UIKitStore)?void 0:e.sysMsgStore)||t.getTotalUnreadMsgsCount(),y()});return m(()=>{var e;return null==(e=null==c?void 0:c.value)?void 0:e.length},()=>{P(null==c?void 0:c.value)}),V(()=>{var e;(null==(e=c.value)?void 0:e.length)&&P(null==c?void 0:c.value)}),x(()=>{u.value=!1,g.value=""}),I(()=>{Y(),G(),b()}),(e,t)=>(s(),o("div",{class:"conversation-wrapper"},[u.value?(s(),o("div",{key:0,class:"dropdown-mark",onTouchstart:O},null,32)):M("",!0),d($,{label:"消息"}),c.value&&0!==c.value.length?(s(),o("div",{key:2,class:"conversation-list-wrapper"},[(s(!0),o(r,null,v(c.value,e=>(s(),o("div",{key:e.renderKey},[(s(),S(w,{key:e.renderKey,showMoreActions:g.value===e.conversationId,conversation:e,onDelete:h,onStickyToTop:f,onClick:U,onLeftSlide:k},null,8,["showMoreActions","conversation"]))]))),128))])):(s(),o("div",{key:1},[c.value&&0!==c.value.length?M("",!0):(s(),S(C,{key:0,text:a(l)("conversationEmptyText")},null,8,["text"]))]))]))}}),[["__scopeId","data-v-e962e9a7"]]),G=P(e({__name:"index",setup(e){let t;return uni.$UIKitStore.userStore.myUserInfo,V(()=>{var e,s,o;null==(e=uni.$UIKitStore)||e.uiStore.selectConversation("");const a=null==(o=null==(s=uni.$UIKitStore)?void 0:s.sdkOptions)?void 0:o.enableV2CloudConversation;t=setTimeout(()=>{var e,t,s,o;0===(a?null==(t=null==(e=uni.$UIKitNIM)?void 0:e.V2NIMConversationService)?void 0:t.getTotalUnreadCount():null==(o=null==(s=uni.$UIKitNIM)?void 0:s.V2NIMLocalConversationService)?void 0:o.getTotalUnreadCount())?uni.hideTabBarRedDot({index:0}):uni.showTabBarRedDot({index:0})},800)}),E(async()=>{}),x(()=>{clearTimeout(t)}),(e,t)=>(s(),S(b))}}),[["__scopeId","data-v-39006372"]]);export{G as default};
