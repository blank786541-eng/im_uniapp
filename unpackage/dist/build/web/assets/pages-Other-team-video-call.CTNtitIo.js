import{d as e,g as n,D as a,az as t,au as o,ar as i,aw as c,j as s,at as l,as as r,ap as u,av as d,aA as I,o as m,a as v,k as h,F as p,r as f,l as g,u as w,f as y,t as x,e as S,ax as N,ay as U}from"./index-CA_4_S1o.js";import{A as k}from"./Avatar.cDMQ39ID.js";import{A as b}from"./AssetsImage.D01ldk7e.js";import{b as j}from"./uni-app.es.f5Xd5cz1.js";import{N as M}from"./NERTC.C_LcuRBv.js";import{c as $}from"./config.A7D2bxor.js";import{_ as C}from"./_plugin-vue_export-helper.BCo6x5W8.js";const K=C(e({__name:"team-video-call",setup(e){const C=n(!1),K=n([]);let E,T,_,A,R,V="",q="",B=[];const P=n(!1),L=n(!1);let O=a({uid:"",roomId:null,requestId:"",channelName:"",teamId:"",type:1});const D=n(!1),F=`name=${uni.$UIKitStore.userStore.myUserInfo.name||uni.$UIKitStore.userStore.myUserInfo.accountId}&accountId=${uni.$UIKitStore.userStore.myUserInfo.accountId}`;j(async e=>{if(T=M.createClient({appkey:$.appKey,debug:!0}),e.roomId)V=e.channelName,q=e.requestId,A=o(),O=e,R=await uni.$UIKitNIM.V2NIMSignallingService.joinRoom({channelId:O.roomId});else{let n=await t(T,e.conversationId,e.teamId);q=n.requestId,V=n.channelName,E=n.roomInfo,A=n.streamId,ae(),L.value=!0,O.roomId=E.channelId,O.channelName=n.channelName,O.conversationId=e.conversationId,O.teamId=e.teamId,console.warn(n,"obj======"),uni.$emit("open-team-call",{teamId:e.teamId,requestId:n.requestId,channelName:n.channelName,channelId:E.channelId,inviterAccountId:uni.$UIKitStore.userStore.myUserInfo.accountId})}i("/static/call-music.mp3","call"),ee()});const z=n(!1);async function Y(){z.value=!z.value,z.value?B.forEach(e=>{e.muteAudio()}):B.forEach(e=>{e.unmuteAudio()})}function G(){if(P.value)uni.showToast({title:"待群主解除禁言",icon:"none"});else if(C.value=!C.value,C.value)console.warn("关闭mic"),_.close({type:"audio"}).then(()=>{console.warn("关闭 mic sucess")}).catch(e=>{console.warn("关闭 mic 失败: ",e)});else{if(console.warn("打开mic"),!_)return;_.open({type:"audio"}).then(()=>{console.warn("打开mic sucess")}).catch(e=>{console.warn("打开mic失败: ",e)})}}function H(){if(P.value)console.warn("关闭mic"),_.close({type:"audio"}).then(()=>{console.warn("关闭 mic sucess")}).catch(e=>{console.warn("关闭 mic 失败: ",e)});else{if(console.warn("打开mic"),!_)return;_.open({type:"audio"}).then(()=>{console.warn("打开mic sucess")}).catch(e=>{console.warn("打开mic失败: ",e)})}}let J=null;const Q=n("");function W(){_=M.createStream({client:T,uid:A.toString(),audio:!0,video:!1,screen:!1}),_.setAudioProfile("speech_low_quality"),_.init().then(()=>{console.warn("开始发布视频流"),T.publish(_,"audio").then(()=>{console.warn("本地 publish 成功")}).catch(e=>{console.error("本地 publish 失败: ",e)}),J=setInterval(async()=>{let e=await T.getSessionStats();Q.value=U(e.Duration)},1e3),D.value=!0}).catch(e=>{console.warn("音视频初始化失败: ",e),_=null})}function X(e){e.setSubscribeConfig({audio:!0,video:!1,screen:!0}),T.subscribe(e).then(()=>{console.warn("本地 subscribe 成功")}).catch(e=>{console.warn("本地 subscribe 失败: ",e)})}async function Z(){d("call"),i("/static/call-stop.mp3","jieting"),console.log(O,"joinRoom=====");try{await uni.$UIKitNIM.V2NIMSignallingService.acceptInvite({channelId:O.roomId,inviterAccountId:O.uid,requestId:O.requestId,serverExtension:F})}catch(e){console.log(e.toString(),"joinRoom=====error")}D.value=!0,console.warn(O.roomId,A,"joinROOM=====",O.channelName),await T.join({channelName:O.roomId,uid:A.toString()}),W(),ae()}async function ee(e){let n=uni.getStorageSync("inviteUsers")||[];K.value=await uni.$UIKitStore.userStore.getUserListFromCloudActive(n);let a=K.value.findIndex(e=>e.accountId==uni.$UIKitStore.userStore.myUserInfo.accountId);if(a>-1&&K.value.splice(a,1),e){let n=K.value.findIndex(n=>n.accountId==e);K.value.splice(n,1)}}async function ne(){if(i("/static/call-stop.mp3","jujue"),D.value){let n=L.value?E.channelId:R.roomInfo.channelInfo.channelId;console.warn(E,"destroy=======",R);try{await uni.$UIKitNIM.V2NIMSignallingService.leaveRoom(n,!1,F)}catch(e){console.error(e.toString(),"error======")}T.leave()}else if(L.value){uni.getStorageSync("inviteUsers").forEach(e=>{uni.$UIKitNIM.V2NIMSignallingService.cancelInvite({channelId:O.roomId,inviteeAccountId:e,requestId:q}).catch(e=>{console.log(e.toString(),"err========")})}),T.leave()}else await uni.$UIKitNIM.V2NIMSignallingService.leaveRoom(O.roomId,!1,F+"&type=reject");J&&(clearInterval(J),J=null),uni.navigateBack()}function ae(){c(T,(e,n)=>{var a,t;e==N.PeerOnline||(e==N.PeerLeave?console.warn("CallEventType.PeerLeave",n):e==N.StreamAdded?async function(e,n){B.some(e=>e.getId()===n)?(console.warn("收到已订阅的远端发布，需要更新",e),B=B.map(a=>a.getId()===n?e:a),await X(e)):B.length<19?(console.warn("收到新的远端发布消息",e),B=B.concat(e),await X(e)):console.warn("房间人数已满")}(n.stream,n.uid):e==N.StreamRemove?(a=n.stream,t=n.uid,B=B.map(e=>e.getId()===t?a:e)):e==N.StreamSubscribed&&B.forEach(e=>{e.play(null,{audio:!0,video:!1}).then(()=>{console.warn("播放音频",e.getId())}).catch(e=>{console.warn("播放对方音频失败了: ",e)})}))})}async function te(e,n){ee(e);try{console.warn(V,"res.members======");const e=await uni.$UIKitNIM.V2NIMSignallingService.getRoomInfoByChannelName(V);if(console.warn(e.members,"res.members======"),1==e.members.length)if(D.value){uni.showToast({title:"人员已全部离开,即将挂断",duration:3e3});const e=setTimeout(()=>{I({channelId:n,type:1,uid:O.teamId,client:T}),J&&clearTimeout(J),e&&clearTimeout(e),uni.$UIKitNIM.V2NIMSignallingService.leaveRoom(n,!1,F),uni.navigateBack()},3e3)}else J&&clearTimeout(J),uni.$UIKitNIM.V2NIMSignallingService.leaveRoom(n,!1,F),uni.navigateBack()}catch(a){}}return n(!1),s(()=>{l(),_&&(_.close({type:"audio"}).then(e=>{_.destroy()}),B.forEach(e=>{e.stop()}),B.forEach(e=>{e.destroy()})),uni.removeStorageSync("inviteUsers"),uni.$off("on-invite"),r(T)}),uni.$on("on-invite",async e=>{const n=u(e.serverExtension),a=e.eventType;if(6==a)d("call"),i("/static/call-stop.mp3","jujue"),await T.join({channelName:E.channelId,uid:A}),D.value=!0,uni.showToast({title:`${n.name} 已加入`,icon:"none",success:()=>{-1==K.value.findIndex(e=>e.accountId==n.accountId)&&K.value.push(n)}}),ae(),W();else if(5==a)uni.showToast({title:`${n.name} 已拒绝加入`,icon:"none",success:()=>{te(n.accountId,e.channelInfo.channelId)}});else if(7==a){const a="reject"==n.type?`${n.name} 已拒绝加入`:`${n.name} 已离开`;uni.showToast({title:a,success:()=>{te(n.accountId,e.channelInfo.channelId)}})}else 4==a?uni.showToast({title:"已取消",icon:"none",duration:1e3,success:()=>{i("jujue"),uni.$UIKitNIM.V2NIMSignallingService.leaveRoom(e.channelInfo.channelId,!1,F),T.leave(),uni.navigateBack()}}):"kickByCreate"==e.serverExtension?uni.showToast({title:"您已被踢出房间",icon:"none",duration:1e3,success:()=>{i("jujue"),uni.$UIKitNIM.V2NIMSignallingService.leaveRoom(e.channelInfo.channelId,!1,F),T.leave(),uni.navigateBack()}}):"muteUser"==e.serverExtension?(P.value=!0,H(),uni.showToast({title:"您已被禁言",icon:"none",duration:1e3,success:()=>{}})):"unMuteUser"==e.serverExtension&&(P.value=!1,H(),uni.showToast({title:"您已解除禁言",icon:"none",duration:1e3,success:()=>{}}))}),(e,n)=>(m(),v("div",{class:"call-wrapper"},[h("div",{class:"flex-box flex-direction-column",style:{height:"100%"}},[h("div",{class:"flex-box",style:{"flex-wrap":"wrap",padding:"10px"}},[(m(!0),v(p,null,f(K.value,(e,n)=>(m(),v("div",{key:n,class:"flex-box user-item"},[S(k,{account:e.accountId,width:"30px",height:"30px"},null,8,["account"]),h("div",{style:{width:"10px"}}),h("span",null,x(e.name||e.accountId),1),h("div",{style:{width:"10px"}}),L.value?(m(),g(b,{key:0,path:"muteUser"==e.serverExtension?"/static/audio_close.png":"/static/audio_open.png",width:"20px",height:"20px",onClick:a=>function(e,n){"muteUser"!=K.value[n].serverExtension?K.value[n].serverExtension="muteUser":K.value[n].serverExtension="unMuteUser",uni.$UIKitNIM.V2NIMSignallingService.sendControl(O.roomId,e.accountId,K.value[n].serverExtension)}(e,n)},null,8,["path","onClick"])):y("",!0),h("div",{style:{width:"16px"}}),L.value?(m(),g(b,{key:1,path:"/static/cancel.png",width:"16px",height:"16px",onClick:n=>{return a=e.accountId,void uni.$UIKitNIM.V2NIMSignallingService.sendControl(O.roomId,a,"kickByCreate");var a}},null,8,["onClick"])):y("",!0)]))),128))]),h("div",{style:{flex:"1"},class:"flex-center flex-direction-column"},[L.value?y("",!0):(m(),g(k,{key:0,account:w(O).uid},null,8,["account"])),D.value?(m(),v("div",{key:2,class:"default-text font-14",style:{color:"#fff","margin-top":"15px"}}," 正在通话中   "+x(Q.value),1)):(m(),v("div",{key:1,class:"default-text font-14",style:{color:"#fff","margin-top":"15px"}},x(L.value?"等待用户加入":"加入群语音"),1))]),D.value?(m(),v("div",{key:1,class:"call-action"},[h("div",{class:"icon-container",style:{"background-color":"#fff"}},[S(b,{onClick:G,path:C.value||P.value?"/static/voice_close.png":"/static/voice_open.png",width:"30px",height:"30px"},null,8,["path"])]),S(b,{onClick:ne,path:"/static/guaduan.png",width:"80px",height:"80px"}),h("div",{class:"icon-container",style:{"background-color":"#666"}},[S(b,{path:z.value?"/static/audio_close.png":"/static/audio_open.png",width:"30px",height:"30px",onClick:Y},null,8,["path"])])])):(m(),v("div",{key:0,class:"flex-box",style:{"margin-bottom":"60px","justify-content":"space-around"}},[S(b,{onClick:ne,path:"/static/guaduan.png",width:"80px",height:"80px",circle:!0}),L.value?y("",!0):(m(),g(b,{key:0,path:"/static/jieting.png",width:"90px",height:"90px",circle:!0,onClick:Z}))]))])]))}}),[["__scopeId","data-v-b281b9a7"]]);export{K as default};
