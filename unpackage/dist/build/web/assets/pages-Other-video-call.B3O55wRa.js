import{d as e,g as n,D as t,ar as a,j as o,as as i,at as c,E as l,au as s,av as r,aw as u,_ as d,o as I,a as m,k as v,l as S,f as p,t as h,e as g,ax as f,ay as y}from"./index-CA_4_S1o.js";import{N as w}from"./NERTC.C_LcuRBv.js";import{b as N}from"./uni-app.es.f5Xd5cz1.js";import{A as M}from"./Avatar.cDMQ39ID.js";import{A as U}from"./AssetsImage.D01ldk7e.js";import{c as $}from"./config.A7D2bxor.js";import{_}from"./_plugin-vue_export-helper.BCo6x5W8.js";const x=_(e({__name:"video-call",setup(e){let _;const x=n(!1),C=n(),k=t({isSilence:!1,isStop:!1,localUid:"",localStream:null,remoteStreams:[],max:20,devicesId:[],currentDevice:0,showStatistics:!1,uplinkNetworkQuality:"grey",downlinkNetworkQuality:"grey",networkQuality:["grey","green","green","yellow","red","red"],audioSendBitrate:0,videoSendBitrate:0,sendFrameRate:0,sendResolutionHeight:0,sendResolutionWidth:0,vConsole:null,localVideoStatsInterval:null,localAudioStatsInterval:null}),A=`${Date.now()}_${Math.random().toString(7)}`,j=`${Date.now()}_${Math.random().toString(36).substr(2,9)}`,b=n();let T,K,R=null;const V=n(!1);let B=t({uid:"",roomId:null,requestId:"",type:1});const E=n(!1);function D(e,n){k.remoteStreams=k.remoteStreams.map(t=>t.getId()===n?e:t)}async function O(e,n){k.remoteStreams.some(e=>e.getId()===n)?(console.warn("收到已订阅的远端发布，需要更新",e),k.remoteStreams=k.remoteStreams.map(t=>t.getId()===n?e:t),await G(e)):k.remoteStreams.length<k.max-1?(console.warn("收到新的远端发布消息",e),k.remoteStreams=k.remoteStreams.concat(e),await G(e)):console.warn("房间人数已满")}async function P(){R&&(clearInterval(R),R=null),a("/static/call-stop.mp3","jieting");const e=uni.$UIKitNIM.V2NIMConversationIdUtil.p2pConversationId(B.uid);if(E.value&&x.value)return z({channelId:B.roomId,uid:B.uid,type:1,conversationId:e||uni.getStorageSync("currentConversation")}),void q();E.value?await uni.$UIKitNIM.V2NIMSignallingService.cancelInvite({requestId:A,inviteeAccountId:B.uid,channelId:T.roomInfo.channelInfo.channelId}):(await uni.$UIKitNIM.V2NIMSignallingService.rejectInvite({channelId:B.roomId,inviterAccountId:B.uid,requestId:B.requestId}),z({channelId:B.roomId,type:3,conversationId:e,uid:B.uid}),console.log(`${e}`,"uni.$UIKitStore.userStore.myUserInfo.accountId|1|query.uid")),uni.navigateBack()}async function q(){x&&(null!=T&&await uni.$UIKitNIM.V2NIMSignallingService.leaveRoom(T.roomInfo.channelInfo.channelId),null!=K&&await uni.$UIKitNIM.V2NIMSignallingService.leaveRoom(K.roomInfo.channelInfo.channelId),await _.leave()),R&&(clearInterval(R),R=null),uni.navigateBack()}N(async e=>{_=w.createClient({appkey:$.appKey,debug:!0}),B=e,uni.$UIKitStore.userStore.getUserForceActive(e.uid).then(e=>{b.value=e}),k.localUid=uni.$UIKitStore.userStore.myUserInfo.accountId,e.roomId||(B.roomId=j,async function(){if(E.value=!0,T=await uni.$UIKitNIM.V2NIMSignallingService.call({channelName:B.roomId,calleeAccountId:B.uid,requestId:A,serverExtension:uni.getStorageSync("currentConversation"),channelType:l.V2NIMSignallingChannelType.V2NIM_SIGNALLING_CHANNEL_TYPE_AUDIO}),200!=T.callStatus)uni.showToast({title:"对方不在线",icon:"none",duration:1e3,success:()=>{q()}})}()),a("/static/call-music.mp3","call")}),o(async()=>{R&&(clearInterval(R),R=null),null!=k.localStream&&k.localStream.close({type:"audio"}).then(e=>{k.localStream.destroy()})(k.remoteStreams).destroy(),i(_),uni.$off("on-invite"),c()});const L=n("");const Q=n(!1);async function Y(){Q.value=!Q.value,Q.value?k.remoteStreams.forEach(e=>{e.stop("audio")}):k.remoteStreams.forEach(e=>{e.resume()})}function F(){k.localStream=w.createStream({client:_,uid:s(),audio:!0,video:!1,screen:!1}),k.localStream.setAudioProfile("speech_low_quality"),k.localStream.init().then(()=>{console.warn("开始发布视频流"),_.publish(k.localStream,"audio").then(()=>{console.warn("本地 publish 成功")}).catch(e=>{console.error("本地 publish 失败: ",e)}),R&&(clearInterval(R),R=null),R=setInterval(async()=>{let e=await _.getSessionStats();console.log("===== sessionStats ====="),console.log(`Duration: ${e.Duration}`),L.value=y(e.Duration),console.log(`RecvBitrate: ${e.RecvBitrate}`),console.log(`RecvBytes: ${e.RecvBytes}`),console.log(`SendBitrate: ${e.SendBitrate}`),console.log(`SendBytes: ${e.SendBytes}`),console.log(`UserCount: ${e.UserCount}`)},1e3),x.value=!0}).catch(e=>{console.warn("音视频初始化失败: ",e.message,e.code),k.localStream=null})}function G(e){e.setSubscribeConfig({audio:1==B.type,video:!1,screen:!0}),_.subscribe(e).then(()=>{console.warn("本地 subscribe 成功")}).catch(e=>{console.warn("本地 subscribe 失败: ",e)})}function H(){const{isSilence:e}=k;if(k.isSilence=!e,k.isSilence)console.warn("关闭mic"),k.localStream.close({type:"audio"}).then(()=>{console.warn("关闭 mic sucess")}).catch(e=>{console.warn("关闭 mic 失败: ",e)});else{if(console.warn("打开mic"),!k.localStream)return;k.localStream.open({type:"audio"}).then(()=>{console.warn("打开mic sucess")}).catch(e=>{console.warn("打开mic失败: ",e)})}}async function W(){r("call"),K=await uni.$UIKitNIM.V2NIMSignallingService.callSetup({channelId:B.roomId,callerAccountId:B.uid,requestId:B.requestId}),200==K.callStatus?(await _.join({channelName:B.audioRoomId,uid:s()}),a("/static/call-stop.mp3","jieting"),u(_,(e,n)=>{e==f.PeerOnline||(e==f.StreamAdded?O(n.stream,n.uid):e==f.StreamRemove?D(n.stream,n.uid):e==f.StreamSubscribed&&k.remoteStreams.forEach(e=>{e.play(null,{audio:!0,video:!1}).then(()=>{console.warn("播放音频",e.getId())}).catch(e=>{console.warn("播放对方音频失败了: ",e)})}))}),F(),E.value=!1):uni.showToast({title:"对方不在线",icon:"none",duration:1e3,success:()=>{q()}})}async function z(e){let n=await _.getSessionStats();const t=uni.$UIKitNIM.V2NIMMessageCreator.createCallMessage(1,e.channelId,e.type||1,x.value?[{accountId:B.uid,duration:Math.ceil(n.Duration)||0},{accountId:uni.$UIKitStore.userStore.myUserInfo.accountId,duration:Math.ceil(n.Duration)||0}]:[{accountId:B.uid},{accountId:uni.$UIKitStore.userStore.myUserInfo.accountId}]);await uni.$UIKitStore.msgStore.sendMessageActive({msg:t,conversationId:e.conversationId,conversationType:l.V2NIMConversationType.V2NIM_CONVERSATION_TYPE_P2P,sendBefore:()=>{uni.$emit(d.ON_SCROLL_BOTTOM)}})}return uni.$on("on-invite",async e=>{const n=e.eventType,t=uni.$UIKitNIM.V2NIMConversationIdUtil.p2pConversationId(B.uid);if(6==n)V.value=!0,await _.join({channelName:B.roomId,uid:s().toString()}),r("call"),a("/static/call-stop.mp3","jieting"),F(),u(_,(e,n)=>{e==f.PeerOnline?x.value=!0:e==f.PeerLeave||(e==f.StreamAdded?O(n.stream,n.uid):e==f.StreamRemove?D(n.stream,n.uid):e==f.StreamSubscribed?k.remoteStreams.forEach(e=>{e.play(null,{audio:!0,video:!1}).then(()=>{console.warn("播放音频",e.getId())}).catch(e=>{console.warn("播放对方音频失败了: ",e)})}):e==f.AUDIOLEVEL_NOT_SUPPORTED&&q())});else if(4==n)uni.showToast({title:"已取消",icon:"none",duration:1e3,success:()=>{a("jujue"),z({channelId:e.channelInfo.channelId,conversationId:t,type:2,uid:B.uid}),q()}});else if(5==n){const n=e.operatorAccountId==e.inviterAccountId?"已取消":"对方已拒绝";uni.showToast({title:n,icon:"none",duration:1e3,success:()=>{a("jujue");const n=e.operatorAccountId==e.inviterAccountId?uni.getStorageSync("currentConversation"):t;z({channelId:e.channelInfo.channelId,conversationId:n,type:2,uid:B.uid}),q()}})}else 7==n&&uni.showToast({title:"对方已挂断",icon:"none",duration:1e3,success:()=>{z({channelId:e.channelInfo.channelId,conversationId:uni.getStorageSync("currentConversation"),type:2,uid:B.uid}),a("jujue"),q()}})}),(e,n)=>(I(),m("div",{class:"call-wrapper",ref_key:"renderBox",ref:C},[v("div",{class:"user"},[b.value&&b.value.accountId?(I(),S(M,{key:0,account:b.value.accountId,width:"100px",height:"100px"},null,8,["account"])):p("",!0),b.value&&b.value.accountId?(I(),m("div",{key:1,class:"default-text font-14",style:{color:"#fff","margin-top":"6px"}},h(b.value.accountId),1)):p("",!0),x.value?(I(),m("div",{key:3,class:"default-text font-14",style:{color:"#fff","margin-top":"6px"}}," 正在通话中   "+h(L.value),1)):(I(),m("div",{key:2,class:"default-text font-14",style:{color:"#fff","margin-top":"6px"}},h(E.value?"等待对方接听。。。":"邀请你语音通话"),1))]),x.value?(I(),m("div",{key:1,class:"call-action"},[v("div",{class:"icon-container",style:{"background-color":"#fff"}},[g(U,{onClick:H,path:k.isSilence?"/static/voice_close.png":"/static/voice_open.png",width:"30px",height:"30px"},null,8,["path"])]),g(U,{onClick:P,path:"/static/guaduan.png",width:"80px",height:"80px"}),v("div",{class:"icon-container",style:{"background-color":"#666"}},[g(U,{path:Q.value?"/static/audio_close.png":"/static/audio_open.png",width:"30px",height:"30px",onClick:Y},null,8,["path"])])])):(I(),m("div",{key:0,class:"call-action"},[g(U,{onClick:P,path:"/static/guaduan.png",width:"80px",height:"80px",circle:!0}),E.value?p("",!0):(I(),S(U,{key:0,path:"/static/jieting.png",width:"90px",height:"90px",circle:!0,onClick:W}))]))],512))}}),[["__scopeId","data-v-20a4223e"]]);export{x as default};
